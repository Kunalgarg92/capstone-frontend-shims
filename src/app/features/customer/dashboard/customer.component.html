<!-- customer-dashboard.component.html -->
<div class="customer-container">
  <!-- Professional Header -->
  <header class="dashboard-header">
    <div class="welcome">
      <h1>User Dashboard</h1>
      <p>Manage your health security and claims from one central hub.</p>
    </div>
    <div class="user-badge" *ngIf="userId > 0">
      <span class="avatar">üë§</span>
      <span>User ID: #{{ formattedUserId }}</span>
    </div>
  </header>

  <!-- Navigation Tabs -->
  <nav class="tab-nav">
    <button [class.active]="activeTab() === 'plans'" (click)="activeTab.set('plans')">
      Explore Plans
    </button>
    <button [class.active]="activeTab() === 'policies'" (click)="activeTab.set('policies')">
      My Active Policies
    </button>
    <button [class.active]="activeTab() === 'claims'" (click)="activeTab.set('claims')">
      Claims History
    </button>
  </nav>

  <main class="content-area">
    <div *ngIf="activeTab() === 'plans'" class="plans-grid">
      <div *ngFor="let plan of plans()" class="plan-card">
        <div class="plan-header">
          <h3>{{ plan.name | uppercase }}</h3>
          <span class="duration">{{ plan.durationYears }} Years</span>
        </div>
        <div class="plan-body">
          <div class="data-row">
            <span class="label">Coverage Limit</span>
            <span class="value">‚Çπ{{ plan.coverageLimit | number }}</span>
          </div>
          <div class="data-row">
            <span class="label">Annual Premium</span>
            <span class="value premium">‚Çπ{{ plan.premiumAmount | number }}</span>
          </div>
        </div>

        <ng-container *ngIf="isEnrolled(plan.id); else enrollBtn">
          <button class="btn-enrolled" disabled><span class="icon">‚úÖ</span> Active Policy</button>
        </ng-container>

        <ng-template #enrollBtn>
          <button class="btn-enroll" (click)="onEnroll(plan.id)">Enroll Now</button>
        </ng-template>
      </div>
    </div>
    <!-- FIXED: Added this closing div for plans-grid -->

    <!-- SECTION 2: MY POLICIES -->
    <div *ngIf="activeTab() === 'policies'" class="policy-section">
      <div *ngIf="myPolicies().length === 0" class="empty-state">
        No active policies found. Explore plans to get started.
      </div>

      <table *ngIf="myPolicies().length > 0" class="pro-table">
        <thead>
          <tr>
            <th>Policy ID</th>
            <th>Plan Name</th>
            <th>Effective Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of myPolicies()" (click)="openPolicyDetails(p)" class="clickable-row">
            <td>#POL-{{ p.id }}</td>
            <td>
              <strong>{{ p.plan?.name | uppercase }}</strong>
            </td>
            <td>{{ p.startDate | date }}</td>
            <td><span class="status-pill status-active">Active</span></td>
            <td>
              <button class="btn-claim" (click)="openClaimForm(p)">File New Claim</button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- POLICY DETAILS VIEW -->
    <div *ngIf="activeTab() === 'policy_details'" class="policy-details">
      <div class="details-header">
        <h2>{{ selectedPolicy()?.plan?.name | uppercase }}</h2>

        <span class="status-pill status-active">
          {{ selectedPolicy()?.status }}
        </span>
      </div>

      <div class="details-grid">
        <div>
          <label>Policy ID</label>
          <p>#POL-{{ selectedPolicy()?.id }}</p>
        </div>

        <div>
          <label>Coverage Limit</label>
          <p>‚Çπ{{ selectedPolicy()?.plan?.coverageLimit | number }}</p>
        </div>

        <div>
          <label>Start Date</label>
          <p>{{ selectedPolicy()?.startDate | date }}</p>
        </div>

        <div>
          <label>End Date</label>
          <p>{{ selectedPolicy()?.endDate | date }}</p>
        </div>
      </div>

      <!-- PREMIUM SCHEDULE -->
      <h3>Annual Premium Schedule</h3>
      <table class="pro-table">
        <thead>
          <tr>
            <th>Year</th>
            <th>Due Date</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let p of premiumSchedule()">
            <td>Year {{ p.year }}</td>
            <td>{{ p.dueDate | date }}</td>
            <td>‚Çπ{{ p.amount | number }}</td>
            <td>
              <span
                class="status-pill"
                [ngClass]="{
                  'status-active': p.status === 'SUCCESS',
                  'status-pending': p.status === 'PENDING',
                  'status-failed': p.status === 'FAILED',
                  'status-due': p.status === 'DUE'
                }"
              >
                {{ p.status }}
              </span>
            </td>

            <td>
              <button
                *ngIf="p.status === 'DUE' || p.status === 'FAILED'"
                class="btn-pay"
                (click)="payPremium(p)"
              >
                Pay Now
              </button>

              <span *ngIf="p.status === 'SUCCESS'" class="paid-text"> ‚úî Paid </span>

              <span *ngIf="p.status === 'PENDING'" class="pending-text"> ‚è≥ Pending </span>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- TERMS & CONDITIONS -->
      <h3>Terms & Conditions</h3>
      <ul class="terms">
        <li>Coverage applies only to network hospitals.</li>
        <li>Claims must be filed within 30 days of treatment.</li>
        <li>Pre-existing conditions covered after waiting period.</li>
        <li>Annual premium must be paid on or before due date.</li>
        <li>Policy renewal depends on premium clearance.</li>
      </ul>

      <button class="btn-back" (click)="activeTab.set('policies')">‚Üê Back to Policies</button>
    </div>

    <!-- SECTION 3: CLAIM FORM -->
    <div *ngIf="activeTab() === 'claim_form'" class="form-container">
      <div class="form-card">
        <h2>Submit Reimbursement Claim</h2>
        <p class="subtitle">Policy: #POL-{{ selectedPolicyForClaim?.id }}</p>

        <form (submit)="submitClaim($event)" enctype="multipart/form-data">
          <div class="form-grid">
            <div class="input-group">
              <label>Patient Name</label>
              <input type="text" name="patientName" required placeholder="Full Name" />
            </div>
            <div class="input-group">
              <label>Treatment Cost (‚Çπ)</label>
              <input type="number" name="treatmentCost" required />
            </div>
            <div class="input-group full">
              <label>Hospital Name</label>
              <input type="text" name="hospitalName" required />
            </div>
            <div class="input-group full">
              <label>Hospital Address</label>
              <textarea name="hospitalAddress" rows="2" required></textarea>
            </div>
            <div class="input-group full">
              <label>Upload Medical Documents (Bills, Prescriptions)</label>
              <input
                type="file"
                multiple
                name="documents"
                (change)="onFileSelected($event, null)"
                required
              />
            </div>
          </div>
          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="activeTab.set('policies')">
              Cancel
            </button>
            <button type="submit" class="btn-submit">Submit Claim to Officer</button>
          </div>
        </form>
      </div>
    </div>

    <!-- SECTION 4: MY CLAIMS -->
    <div *ngIf="activeTab() === 'claims'" class="claims-history">
      <div *ngFor="let c of myClaims()" class="claim-record">
        <div class="claim-info">
          <h4>{{ c.hospitalName }}</h4>
          <p>Patient: {{ c.patientName }} | Treatment Cost: ‚Çπ{{ c.treatmentCost | number }}</p>
          <small>Submitted on: {{ c.createdAt | date }}</small>
        </div>
        <div class="claim-status">
          <span class="status-badge" [ngClass]="c.status?.toLowerCase() || 'pending'">
            {{ c.status || 'Under Review' }}
          </span>
        </div>
      </div>
    </div>
  </main>
</div>